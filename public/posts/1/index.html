<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>1 | CineSigil0 çš„æŠ€æœ¯åšå®¢</title>
<meta name="keywords" content="">
<meta name="description" content="
é€è§†å†…å­˜æ¨¡å‹ï¼šè§£æ„æ ˆå¸§ç”Ÿå‘½å‘¨æœŸä¸å †åˆ†é…çš„æœ¬è´¨å·®å¼‚
æ ¸å¿ƒè¯¯åŒºï¼šç±»å‹ä¸å­˜å‚¨çš„æ··æ·†
åœ¨ C è¯­è¨€çš„å·¥ç¨‹å®è·µä¸­ï¼Œåˆå­¦è€…æœ€å®¹æ˜“é™·å…¥çš„è®¤çŸ¥é™·é˜±ä¾¿æ˜¯å°†â€œæ•°æ®ç±»å‹â€ä¸â€œå­˜å‚¨åŒºåŸŸâ€å¼ºè¡Œç»‘å®šã€‚

â€œæ ˆç©ºé—´æ˜¯æ•°ç»„ï¼Œå †ç©ºé—´æ˜¯æŒ‡é’ˆï¼Ÿâ€ â€”â€” è¿™ä¸ªå‘½é¢˜ä»åº•å±‚é€»è¾‘ä¸Šå°±æ˜¯é”™è¯¯çš„ã€‚

è¿™ç§äºŒå…ƒå¯¹ç«‹çš„ç†è§£æ¨¡å‹ï¼Œç›´æ¥å¯¼è‡´äº†é‡æŒ‡é’ˆã€æ ˆæº¢å‡ºï¼ˆStack Overflowï¼‰ä»¥åŠå†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰ç­‰ç¾éš¾æ€§åæœã€‚è¦å†™å‡ºå·¥ä¸šçº§çš„ C ä»£ç ï¼Œå¿…é¡»é¦–å…ˆå‰¥ç¦»è¡¨è±¡ï¼Œå»ºç«‹å¯¹ è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆVirtual Address Spaceï¼‰ çš„ç²¾ç¡®ç‰©ç†æ„ŸçŸ¥ã€‚

æ ˆï¼ˆStackï¼‰ï¼šé«˜é¢‘äº¤æ˜“çš„â€œç¬æ—¶å·¥ä½â€
1. ç‰©ç†æœ¬è´¨ï¼šå¯„å­˜å™¨çš„å„ç§åç§»é‡
æ ˆä¸æ˜¯ä¸€ä¸ªé™æ€å®¹å™¨ï¼Œè€Œæ˜¯ä¸€ä¸ªåŠ¨æ€çš„æ‰§è¡Œæµã€‚åœ¨ x86-64 æ¶æ„ä¸‹ï¼Œæ ˆçš„æ“ä½œæå…¶å»‰ä»·ï¼Œæœ¬è´¨ä¸Šåªæ˜¯æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ˆrspï¼‰çš„åŠ å‡è¿ç®—ã€‚

åˆ†é…ï¼ˆAllocï¼‰ï¼šsub rsp, 40 ï¼ˆæ ˆé¡¶æŒ‡é’ˆä¸‹ç§»ï¼Œåˆ’å‡ºç©ºé—´ï¼‰ã€‚
é‡Šæ”¾ï¼ˆFreeï¼‰ï¼šadd rsp, 40 ï¼ˆæ ˆé¡¶æŒ‡é’ˆä¸Šç§»ï¼Œæ”¶å›ç©ºé—´ï¼‰ã€‚

2. å±€éƒ¨å˜é‡çš„ç”Ÿå­˜æ‚–è®º
å½“ä½ åœ¨å‡½æ•°å†…éƒ¨å£°æ˜ int a[10]; æ—¶ï¼Œç¼–è¯‘å™¨å¹¶æ²¡æœ‰â€œåˆ›é€ â€å†…å­˜ï¼Œå®ƒåªæ˜¯åœ¨ç¼–è¯‘æœŸè®¡ç®—å¥½äº†åç§»é‡ã€‚
void func() {
    int a;       // æ ˆä¸Šçš„æ ‡é‡
    int b[10];   // æ ˆä¸Šçš„æ•°ç»„
    char *p;     // æ ˆä¸Šçš„æŒ‡é’ˆå˜é‡
}
æ·±åº¦è§£æï¼š

ä½ç½®ï¼šæ— è®ºæ˜¯æ•°ç»„ b è¿˜æ˜¯æŒ‡é’ˆ pï¼Œå®ƒä»¬æœ¬èº«éƒ½ç‰©ç†å­˜å‚¨åœ¨**æ ˆå¸§ï¼ˆStack Frameï¼‰**å†…ã€‚
ç”Ÿå‘½å‘¨æœŸï¼šæ ˆéµå¾ª LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰ åŸåˆ™ã€‚å‡½æ•° func çš„å³èŠ±æ‹¬å· } å¯¹åº”ç€æ±‡ç¼–æŒ‡ä»¤ leave å’Œ retã€‚ä¸€æ—¦æ‰§è¡Œï¼Œrsp å¯„å­˜å™¨å›é€€ï¼Œè¿™ç‰‡å†…å­˜åŒºåŸŸç¬é—´è¢«æ ‡è®°ä¸ºâ€œæ— æ•ˆâ€ã€‚
æ€§èƒ½ä¼˜åŠ¿ï¼šç”±äºæ ˆå†…å­˜è¿ç»­ï¼Œæåº¦ç¬¦åˆ CPU çš„ L1/L2 ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰ æœºåˆ¶ï¼Œå‘½ä¸­ç‡æé«˜ï¼Œè®¿é—®é€Ÿåº¦æ˜¯å †å†…å­˜çš„æ•°åå€ã€‚


ç»“è®ºï¼šæ ˆæ˜¯ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†çš„â€œé«˜é¢‘äº¤æ˜“åŒºâ€ï¼Œä¸å½’ç¨‹åºå‘˜ç®¡ï¼Œä½ ä¹Ÿæ— æƒæ’æ‰‹ã€‚">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/1/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css" integrity="sha256-2jIR5e&#43;Ge/K3X9WmUVz&#43;1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/1/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="CineSigil0 çš„æŠ€æœ¯åšå®¢ (Alt + H)">CineSigil0 çš„æŠ€æœ¯åšå®¢</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="æ–‡ç« ">
                    <span>æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      1
    </h1>
    <div class="post-meta"><span title='2026-02-06 16:23:38 +0800 CST'>February 6, 2026</span>&nbsp;Â·&nbsp;<span>2 min</span>

</div>
  </header> 
  <div class="post-content"><hr>
<h1 id="é€è§†å†…å­˜æ¨¡å‹è§£æ„æ ˆå¸§ç”Ÿå‘½å‘¨æœŸä¸å †åˆ†é…çš„æœ¬è´¨å·®å¼‚">é€è§†å†…å­˜æ¨¡å‹ï¼šè§£æ„æ ˆå¸§ç”Ÿå‘½å‘¨æœŸä¸å †åˆ†é…çš„æœ¬è´¨å·®å¼‚<a hidden class="anchor" aria-hidden="true" href="#é€è§†å†…å­˜æ¨¡å‹è§£æ„æ ˆå¸§ç”Ÿå‘½å‘¨æœŸä¸å †åˆ†é…çš„æœ¬è´¨å·®å¼‚">#</a></h1>
<h2 id="æ ¸å¿ƒè¯¯åŒºç±»å‹ä¸å­˜å‚¨çš„æ··æ·†">æ ¸å¿ƒè¯¯åŒºï¼šç±»å‹ä¸å­˜å‚¨çš„æ··æ·†<a hidden class="anchor" aria-hidden="true" href="#æ ¸å¿ƒè¯¯åŒºç±»å‹ä¸å­˜å‚¨çš„æ··æ·†">#</a></h2>
<p>åœ¨ C è¯­è¨€çš„å·¥ç¨‹å®è·µä¸­ï¼Œåˆå­¦è€…æœ€å®¹æ˜“é™·å…¥çš„è®¤çŸ¥é™·é˜±ä¾¿æ˜¯å°†â€œ<strong>æ•°æ®ç±»å‹</strong>â€ä¸â€œ<strong>å­˜å‚¨åŒºåŸŸ</strong>â€å¼ºè¡Œç»‘å®šã€‚</p>
<blockquote>
<p><strong>â€œæ ˆç©ºé—´æ˜¯æ•°ç»„ï¼Œå †ç©ºé—´æ˜¯æŒ‡é’ˆï¼Ÿâ€</strong> â€”â€” è¿™ä¸ªå‘½é¢˜ä»åº•å±‚é€»è¾‘ä¸Šå°±æ˜¯é”™è¯¯çš„ã€‚</p>
</blockquote>
<p>è¿™ç§äºŒå…ƒå¯¹ç«‹çš„ç†è§£æ¨¡å‹ï¼Œç›´æ¥å¯¼è‡´äº†é‡æŒ‡é’ˆã€æ ˆæº¢å‡ºï¼ˆStack Overflowï¼‰ä»¥åŠå†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰ç­‰ç¾éš¾æ€§åæœã€‚è¦å†™å‡ºå·¥ä¸šçº§çš„ C ä»£ç ï¼Œå¿…é¡»é¦–å…ˆå‰¥ç¦»è¡¨è±¡ï¼Œå»ºç«‹å¯¹ <strong>è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆVirtual Address Spaceï¼‰</strong> çš„ç²¾ç¡®ç‰©ç†æ„ŸçŸ¥ã€‚</p>
<hr>
<h2 id="æ ˆstacké«˜é¢‘äº¤æ˜“çš„ç¬æ—¶å·¥ä½">æ ˆï¼ˆStackï¼‰ï¼šé«˜é¢‘äº¤æ˜“çš„â€œç¬æ—¶å·¥ä½â€<a hidden class="anchor" aria-hidden="true" href="#æ ˆstacké«˜é¢‘äº¤æ˜“çš„ç¬æ—¶å·¥ä½">#</a></h2>
<h3 id="1-ç‰©ç†æœ¬è´¨å¯„å­˜å™¨çš„å„ç§åç§»é‡">1. ç‰©ç†æœ¬è´¨ï¼šå¯„å­˜å™¨çš„å„ç§åç§»é‡<a hidden class="anchor" aria-hidden="true" href="#1-ç‰©ç†æœ¬è´¨å¯„å­˜å™¨çš„å„ç§åç§»é‡">#</a></h3>
<p>æ ˆä¸æ˜¯ä¸€ä¸ªé™æ€å®¹å™¨ï¼Œè€Œæ˜¯ä¸€ä¸ªåŠ¨æ€çš„æ‰§è¡Œæµã€‚åœ¨ x86-64 æ¶æ„ä¸‹ï¼Œæ ˆçš„æ“ä½œæå…¶å»‰ä»·ï¼Œæœ¬è´¨ä¸Šåªæ˜¯æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ˆ<code>rsp</code>ï¼‰çš„åŠ å‡è¿ç®—ã€‚</p>
<ul>
<li><strong>åˆ†é…ï¼ˆAllocï¼‰</strong>ï¼š<code>sub rsp, 40</code> ï¼ˆæ ˆé¡¶æŒ‡é’ˆä¸‹ç§»ï¼Œåˆ’å‡ºç©ºé—´ï¼‰ã€‚</li>
<li><strong>é‡Šæ”¾ï¼ˆFreeï¼‰</strong>ï¼š<code>add rsp, 40</code> ï¼ˆæ ˆé¡¶æŒ‡é’ˆä¸Šç§»ï¼Œæ”¶å›ç©ºé—´ï¼‰ã€‚</li>
</ul>
<h3 id="2-å±€éƒ¨å˜é‡çš„ç”Ÿå­˜æ‚–è®º">2. å±€éƒ¨å˜é‡çš„ç”Ÿå­˜æ‚–è®º<a hidden class="anchor" aria-hidden="true" href="#2-å±€éƒ¨å˜é‡çš„ç”Ÿå­˜æ‚–è®º">#</a></h3>
<p>å½“ä½ åœ¨å‡½æ•°å†…éƒ¨å£°æ˜ <code>int a[10];</code> æ—¶ï¼Œç¼–è¯‘å™¨å¹¶æ²¡æœ‰â€œåˆ›é€ â€å†…å­˜ï¼Œå®ƒåªæ˜¯åœ¨ç¼–è¯‘æœŸè®¡ç®—å¥½äº†åç§»é‡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> a;       <span style="color:#75715e">// æ ˆä¸Šçš„æ ‡é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> b[<span style="color:#ae81ff">10</span>];   <span style="color:#75715e">// æ ˆä¸Šçš„æ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p;     <span style="color:#75715e">// æ ˆä¸Šçš„æŒ‡é’ˆå˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><strong>æ·±åº¦è§£æï¼š</strong></p>
<ul>
<li><strong>ä½ç½®</strong>ï¼šæ— è®ºæ˜¯æ•°ç»„ <code>b</code> è¿˜æ˜¯æŒ‡é’ˆ <code>p</code>ï¼Œå®ƒä»¬æœ¬èº«éƒ½ç‰©ç†å­˜å‚¨åœ¨**æ ˆå¸§ï¼ˆStack Frameï¼‰**å†…ã€‚</li>
<li><strong>ç”Ÿå‘½å‘¨æœŸ</strong>ï¼šæ ˆéµå¾ª <strong>LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰</strong> åŸåˆ™ã€‚å‡½æ•° <code>func</code> çš„å³èŠ±æ‹¬å· <code>}</code> å¯¹åº”ç€æ±‡ç¼–æŒ‡ä»¤ <code>leave</code> å’Œ <code>ret</code>ã€‚ä¸€æ—¦æ‰§è¡Œï¼Œ<code>rsp</code> å¯„å­˜å™¨å›é€€ï¼Œè¿™ç‰‡å†…å­˜åŒºåŸŸç¬é—´è¢«æ ‡è®°ä¸ºâ€œæ— æ•ˆâ€ã€‚</li>
<li><strong>æ€§èƒ½ä¼˜åŠ¿</strong>ï¼šç”±äºæ ˆå†…å­˜è¿ç»­ï¼Œæåº¦ç¬¦åˆ CPU çš„ <strong>L1/L2 ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰</strong> æœºåˆ¶ï¼Œå‘½ä¸­ç‡æé«˜ï¼Œè®¿é—®é€Ÿåº¦æ˜¯å †å†…å­˜çš„æ•°åå€ã€‚</li>
</ul>
<blockquote>
<p><strong>ç»“è®º</strong>ï¼šæ ˆæ˜¯ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†çš„â€œé«˜é¢‘äº¤æ˜“åŒºâ€ï¼Œä¸å½’ç¨‹åºå‘˜ç®¡ï¼Œä½ ä¹Ÿæ— æƒæ’æ‰‹ã€‚</p>
</blockquote>
<hr>
<h2 id="å †heapæ‰‹åŠ¨ç®¡ç†çš„æŒä¹…åŒ–ä»“åº“">å †ï¼ˆHeapï¼‰ï¼šæ‰‹åŠ¨ç®¡ç†çš„â€œæŒä¹…åŒ–ä»“åº“â€<a hidden class="anchor" aria-hidden="true" href="#å †heapæ‰‹åŠ¨ç®¡ç†çš„æŒä¹…åŒ–ä»“åº“">#</a></h2>
<h3 id="1-ç‰©ç†æœ¬è´¨é“¾è¡¨ç®¡ç†çš„ç¢ç‰‡åŒ–å†…å­˜">1. ç‰©ç†æœ¬è´¨ï¼šé“¾è¡¨ç®¡ç†çš„ç¢ç‰‡åŒ–å†…å­˜<a hidden class="anchor" aria-hidden="true" href="#1-ç‰©ç†æœ¬è´¨é“¾è¡¨ç®¡ç†çš„ç¢ç‰‡åŒ–å†…å­˜">#</a></h3>
<p>ä¸åŒäºæ ˆçš„çº¿æ€§å¢é•¿ï¼Œå †æ˜¯ä¸€ä¸ªå·¨å¤§çš„ã€ç”±é“¾è¡¨ï¼ˆæˆ–çº¢é»‘æ ‘ï¼‰ç®¡ç†çš„å†…å­˜æ± ã€‚å½“ä½ è°ƒç”¨ <code>malloc(100)</code> æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸å‘ç”Ÿäº†å¤æ‚çš„äº¤äº’ï¼š</p>
<ol>
<li><strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼šç”¨æˆ·æ€è¯·æ±‚å†…æ ¸æ€ï¼ˆé€šè¿‡ <code>brk</code> æˆ– <code>mmap</code> ç³»ç»Ÿè°ƒç”¨ï¼‰æ‰©å±•å †è¾¹ç•Œã€‚</li>
<li><strong>åˆ†é…å™¨ç®—æ³•</strong>ï¼šGlibc çš„ <code>malloc</code> ä¼šéå†<strong>ç©ºé—²é“¾è¡¨ï¼ˆFree Listï¼‰</strong>ï¼Œå¯»æ‰¾ä¸€å—è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜ï¼Œåˆ†å‰²ã€æ ‡è®°å¤´éƒ¨ä¿¡æ¯ï¼ˆMetadataï¼‰ï¼Œç„¶åè¿”å›æŒ‡é’ˆã€‚</li>
</ol>
<h3 id="2-è·¨è¶Šè¾¹ç•Œçš„æ§åˆ¶æƒ">2. è·¨è¶Šè¾¹ç•Œçš„æ§åˆ¶æƒ<a hidden class="anchor" aria-hidden="true" href="#2-è·¨è¶Šè¾¹ç•Œçš„æ§åˆ¶æƒ">#</a></h3>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå †å†…å­˜æ…¢ï¼Œä½†çµæ´»ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> ptr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
</span></span></code></pre></div><p>è¿™è¡Œä»£ç æ„å»ºäº†ä¸€ä¸ªè·¨è¶Šå†…å­˜åŒºåŸŸçš„â€œæ¡¥æ¢â€ï¼š</p>
<ul>
<li><strong>æ ˆç«¯ï¼ˆStack Sideï¼‰</strong>ï¼š<code>ptr</code> æœ¬èº«æ˜¯ä¸€ä¸ª 8 å­—èŠ‚ï¼ˆ64ä½æœºï¼‰çš„æŒ‡é’ˆå˜é‡ï¼Œå­˜åœ¨æ ˆä¸Šï¼Œéšå‡½æ•°æ¶ˆäº¡ã€‚</li>
<li><strong>å †ç«¯ï¼ˆHeap Sideï¼‰</strong>ï¼š<code>malloc</code> åˆ†é…çš„ 40 å­—èŠ‚å®ä½“ï¼Œå­˜åœ¨å †ä¸Šï¼Œä¸å‡½æ•°ç”Ÿå‘½å‘¨æœŸæ— å…³ã€‚</li>
</ul>
<h3 id="3-free-çš„åº•å±‚é€»è¾‘">3. free çš„åº•å±‚é€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#3-free-çš„åº•å±‚é€»è¾‘">#</a></h3>
<p><strong>ä¸ºä»€ä¹ˆå¿…é¡» freeï¼Ÿ</strong>
å› ä¸ºæ“ä½œç³»ç»Ÿä¸ä¼šè‡ªåŠ¨æ‰«æå †å†…å­˜ã€‚å¦‚æœä½ é”€æ¯äº†æ ˆä¸Šçš„é’¥åŒ™ï¼ˆ<code>ptr</code>ï¼‰ï¼Œè€Œæ²¡æœ‰é”ä¸Šä»“åº“ï¼ˆ<code>free</code>ï¼‰ï¼Œè¿™å—å †å†…å­˜å°†åœ¨è¿›ç¨‹ç»“æŸå‰æ°¸è¿œå¤„äºâ€œå ç”¨â€çŠ¶æ€ã€‚è¿™å°±å½¢æˆäº†<strong>å†…å­˜æ³„æ¼</strong>ã€‚</p>
<p>æ‰€è°“çš„ <code>free(ptr)</code>ï¼Œå®é™…ä¸Šæ˜¯è¯»å– <code>ptr</code> ä¹‹å‰çš„ <strong>Metadataï¼ˆå¤´éƒ¨å…ƒæ•°æ®ï¼‰</strong>ï¼Œè·çŸ¥è¿™å—å†…å­˜çš„å¤§å°ï¼Œç„¶åå°†å…¶é‡æ–°æŒ‚å›â€œç©ºé—²é“¾è¡¨â€ï¼Œä¾›ä¸‹ä¸€æ¬¡ <code>malloc</code> å¤ç”¨ã€‚</p>
<hr>
<h2 id="é€†å‘å®æˆ˜return-ä¹‹åçš„å¹½çµæ•°æ®">é€†å‘å®æˆ˜ï¼šReturn ä¹‹åçš„â€œå¹½çµæ•°æ®â€<a hidden class="anchor" aria-hidden="true" href="#é€†å‘å®æˆ˜return-ä¹‹åçš„å¹½çµæ•°æ®">#</a></h2>
<h3 id="åœºæ™¯-aè¿”å›æ ˆæ•°ç»„è‡´å‘½é”™è¯¯">åœºæ™¯ Aï¼šè¿”å›æ ˆæ•°ç»„ï¼ˆè‡´å‘½é”™è¯¯ï¼‰<a hidden class="anchor" aria-hidden="true" href="#åœºæ™¯-aè¿”å›æ ˆæ•°ç»„è‡´å‘½é”™è¯¯">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">crash_func</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> nums[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>}; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> nums; <span style="color:#75715e">// âŒ è¿”å›æ ˆåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li><strong>ç¾éš¾æ¨æ¼”</strong>ï¼š</li>
</ul>
<ol>
<li><strong>æ‰§è¡Œä¸­</strong>ï¼š<code>nums</code> ä½äºåœ°å€ <code>0x7ff...a0</code>ï¼Œå†…å®¹ä¸º <code>{1, 2, 3}</code>ã€‚</li>
<li><strong>Return ç¬é—´</strong>ï¼š<code>rax</code> å¯„å­˜å™¨ä¿å­˜äº† <code>0x7ff...a0</code>ã€‚</li>
<li><strong>æ ˆå¸§é”€æ¯</strong>ï¼š<code>rsp</code> æŒ‡é’ˆä¸Šç§»ï¼Œåœ°å€è¢«æ ‡è®°ä¸ºâ€œå¯ç”¨åŒºâ€ã€‚æ³¨æ„ï¼šæ­¤æ—¶å†…å­˜é‡Œçš„æ•°æ®å¹¶æœªç«‹å³æŠ¹é™¤ã€‚</li>
<li><strong>è°ƒç”¨è€…æ¥æ”¶</strong>ï¼š<code>int* p = crash_func();</code>ï¼Œ<code>p</code> æŒ‡å‘äº†æ—§åœ°å€ã€‚</li>
<li><strong>å´©æºƒç‚¹</strong>ï¼šä¸€æ—¦è°ƒç”¨ä¸‹ä¸€ä¸ªå‡½æ•°ï¼ˆå¦‚ <code>printf</code>ï¼‰ï¼Œæ–°çš„æ ˆå¸§ä¼šç«‹å³<strong>è¦†ç›–</strong>è¯¥ä½ç½®ã€‚<code>p</code> æŒ‡å‘çš„æ•°æ®ç¬é—´å˜æˆéšæœºä¹±ç ã€‚</li>
</ol>
<h3 id="åœºæ™¯-bè¿”å›å †æŒ‡é’ˆæ­£ç¡®è·¯å¾„">åœºæ™¯ Bï¼šè¿”å›å †æŒ‡é’ˆï¼ˆæ­£ç¡®è·¯å¾„ï¼‰<a hidden class="anchor" aria-hidden="true" href="#åœºæ™¯-bè¿”å›å †æŒ‡é’ˆæ­£ç¡®è·¯å¾„">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">safe_func</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> nums <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... èµ‹å€¼ ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> nums; <span style="color:#75715e">// âœ… è¿”å›å †åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li><strong>å®‰å…¨æ¨æ¼”</strong>ï¼š</li>
</ul>
<ol>
<li><strong>æ ˆå¸§é”€æ¯</strong>ï¼šæ ˆä¸Šçš„æŒ‡é’ˆå˜é‡ <code>nums</code> è¢«é”€æ¯ã€‚</li>
<li><strong>å †å†…å­˜ä¿ç•™</strong>ï¼šå †ä¸Šçš„åœ°å€ä¾ç„¶ä¿ç•™æ•°æ®ã€‚</li>
<li><strong>æ‰€æœ‰æƒè½¬ç§»</strong>ï¼šè°ƒç”¨è€…é€šè¿‡è¿”å›å€¼æ¥ç®¡äº†è¿™å—å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸï¼Œè´Ÿè´£åç»­çš„ <code>free</code>ã€‚</li>
</ol>
<hr>
<h2 id="æ€»ç»“c-è¯­è¨€çš„å“²å­¦">æ€»ç»“ï¼šC è¯­è¨€çš„å“²å­¦<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“c-è¯­è¨€çš„å“²å­¦">#</a></h2>
<p>é€šè¿‡å¯¹æ¯”æ ˆä¸å †ï¼Œæˆ‘ä»¬è§¦åŠäº† C è¯­è¨€è®¾è®¡çš„æ ¸å¿ƒå“²å­¦ï¼š<strong>ä¿¡ä»»ç¨‹åºå‘˜ï¼Œä½†ä¸æä¾›å®‰å…¨æ°”å›Šã€‚</strong></p>
<table>
  <thead>
      <tr>
          <th>ç‰¹æ€§</th>
          <th>æ ˆï¼ˆStackï¼‰</th>
          <th>å †ï¼ˆHeapï¼‰</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>åˆ†é…æ–¹å¼</strong></td>
          <td>CPU æŒ‡ä»¤è‡ªåŠ¨ç®¡ç† (<code>rsp</code>)</td>
          <td>æ˜¾å¼å‡½æ•°è°ƒç”¨ (<code>malloc/free</code>)</td>
      </tr>
      <tr>
          <td><strong>è®¿é—®é€Ÿåº¦</strong></td>
          <td>æå¿«ï¼ˆL1/L2 Cache å‹å¥½ï¼‰</td>
          <td>è¾ƒæ…¢ï¼ˆæ¶‰åŠç³»ç»Ÿè°ƒç”¨ã€é“¾è¡¨éå†ï¼‰</td>
      </tr>
      <tr>
          <td><strong>ç©ºé—´é™åˆ¶</strong></td>
          <td>è¾ƒå°ï¼ˆé€šå¸¸æ•° MBï¼Œç”± OS é¢„è®¾ï¼‰</td>
          <td>å¾ˆå¤§ï¼ˆå—ç‰©ç†å†…å­˜/è™šæ‹Ÿå†…å­˜é™åˆ¶ï¼‰</td>
      </tr>
      <tr>
          <td><strong>æ•°æ®ç”Ÿå‘½å‘¨æœŸ</strong></td>
          <td>éšå‡½æ•°ä½œç”¨åŸŸç»“æŸè‡ªåŠ¨é”€æ¯</td>
          <td>æŒç»­å­˜åœ¨ï¼Œç›´åˆ°æ‰‹åŠ¨é‡Šæ”¾æˆ–è¿›ç¨‹ç»“æŸ</td>
      </tr>
  </tbody>
</table>
<h3 id="-é¿å‘æŒ‡å—">ğŸ’¡ é¿å‘æŒ‡å—<a hidden class="anchor" aria-hidden="true" href="#-é¿å‘æŒ‡å—">#</a></h3>
<ol>
<li><strong>é“å¾‹ 1</strong>ï¼šæ°¸è¿œä¸è¦ Return å±€éƒ¨å˜é‡çš„åœ°å€ï¼ˆ<code>&amp;a</code>ï¼‰æˆ–å±€éƒ¨æ•°ç»„åã€‚</li>
<li><strong>é“å¾‹ 2</strong>ï¼š<code>malloc</code> ä¸ <code>free</code> å¿…é¡»æˆå¯¹å‡ºç°ã€‚</li>
<li><strong>é“å¾‹ 3</strong>ï¼šç†è§£æŒ‡é’ˆåªæ˜¯ä¸€ä¸ªå­˜å‚¨åœ°å€çš„ <code>unsigned long</code>ã€‚å®ƒæŒ‡å‘å“ªé‡Œï¼Œå†³å®šäº†ä½ æ“ä½œå®ƒçš„æƒé™ã€‚</li>
</ol>
<p>ä¸‹æ¬¡å½“ä½ æ•²ä¸‹ <code>malloc</code> æ—¶ï¼Œè¯·è®°ä½ï¼šä½ æ­£åœ¨æ‰‹åŠ¨æ¥ç®¡æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†æƒã€‚<strong>æƒåˆ©è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§ã€‚</strong></p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">CineSigil0 çš„æŠ€æœ¯åšå®¢</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
